# What If Device - Product Requirements Document (PRD)

## Обзор продукта

**What If Device** — это веб-приложение для создания альтернативных сценариев историй с использованием искусственного интеллекта. Пользователи могут вводить свои истории и задавать вопросы "что если", а AI генерирует уникальные альтернативные развития событий. Также доступны текстовые квесты и интерактивные истории.

## Целевая аудитория

- Писатели и авторы, ищущие вдохновение
- Ролевые игроки и мастера подземелий
- Любители творческого письма
- Пользователи, интересующиеся альтернативной историей
- Образовательные учреждения для обучения креативному мышлению
- Игроки в текстовые квесты и хоррор-игры

## Ключевые функции

### 1. Генерация альтернативных сценариев
- **Описание**: Пользователь вводит историю и вопрос "что если", AI генерирует альтернативный сценарий
- **AI Модель**: Qwen/Qwen2.5-72B-Instruct через Hugging Face API
- **Ограничения**: 
  - Максимум 50,000 символов для истории
  - Максимум 10,000 символов для вопроса
  - Rate limiting: 10 запросов/час для гостей, 50 для авторизованных
- **Исправления**: Дублирование сценариев при обновлении страницы устранено (localStorage + проверка состояния)

### 2. Режим Кино (Cinema Mode)
- **Описание**: Интерактивные истории с детерминированными концовками
- **Особенности**:
  - 6 сцен + финальная концовка
  - Выбор из предустановленных вариантов или собственный ввод
  - Seed-based генерация для воспроизводимости
  - Возможность поделиться кодом сессии с друзьями
  - 8 типов концовок: героическая, трагическая, горько-сладкая, открытая, таинственная, комичная, жертва, искупление
- **Жанры**: Киберпанк, Фэнтези, Нуар, Хоррор, Научная фантастика, Мистика

### 3. Режим Приключения (Adventure Mode)
- **Описание**: Классический текстовый квест в замке
- **Особенности**:
  - 22+ локации для исследования
  - Инвентарь с предметами
  - Система команд (осмотреться, идти, взять, инвентарь, назад)
  - Возможность вернуться на предыдущую локацию
  - Интерактивная карта, открывающаяся по мере прохождения
  - Автосохранение прогресса в localStorage и облако (для авторизованных)
  - AI обработка нестандартных команд через JSON-формат

### 4. Хоррор-игра "Пробуждение" (Horror Game)
- **Описание**: Текстовый хоррор-квест с маньяком и множественными концовками
- **Особенности**:
  - 7 различных концовок (только 1 правильная)
  - Механика сна и времени суток (день/ночь)
  - Система крафта (смешивание предметов)
  - Система приготовления еды
  - Маньяк, которого можно превратить в свинью и усыпить
  - 4 ключа для выхода (разбросаны по зданию)
  - Система достижений (22 ачивки)
  - Темная атмосфера с улучшенным контрастом текста
  - AI обработка команд в JSON-формате (короткие ответы, влияние на игру)
  - Команды: осмотреться, идти, взять, спать, включить/выключить свет, смешать, приготовить, использовать, инвентарь

### 5. Шаблоны историй
- **Количество**: 64 готовых шаблона
- **Категории**: Романтика, Фэнтези, Научная фантастика, История, Приключения, Детектив, Бизнес, Военная драма, и др.
- **Функционал**: 
  - Фильтрация по категориям
  - Сортировка (по умолчанию, названию, категории)
  - Копирование текста шаблона
  - Примеры вопросов "что если" для каждого шаблона

### 6. Интерактивный чат
- **Описание**: Продолжение диалога с AI для развития сценария
- **Возможности**:
  - Добавление уточняющих вопросов
  - Сохранение истории переписки
  - Список сохраненных чатов в боковой панели
  - Исправлено: дублирование сценариев при обновлении страницы

### 7. Система аутентификации
- **Провайдеры**: Email/Password, Google OAuth
- **Хранение**: Supabase Auth
- **Режимы**:
  - Гостевой режим (localStorage)
  - Зарегистрированный пользователь (Supabase + облачные сохранения)

### 8. Управление контентом
- Сохранение историй и сценариев (для авторизованных пользователей)
- Просмотр истории созданных сценариев
- Удаление отдельных сценариев
- Автосохранение сессий режима Кино в localStorage
- Облачное сохранение прогресса игр (Adventure, Horror)

## Пользовательский интерфейс

### Дизайн-система
- **Стиль**: Книжная тема (винтаж/пергамент) + киберпанк-элементы.
- **Цветовая палитра**:
  - Светлая тема: Фон кремовый (#f4ecd8), текст темно-коричневый (#3c2f1f).
  - Темная тема: Глубокие коричневые и кофейные тона, текст цвета светлого пергамента (ink/parchment aesthetic).
  - Хоррор-режим: Темно-синие/красные тона с высоким контрастом текста.
- **Типографика**:
  - Заголовки: EB Garamond (serif).
  - UI элементы: Inter (sans-serif).
- **Анимации**: 
  - Плавные переходы (fade, slide, scale)
  - Hover-эффекты (lift, glow)
  - Печатная машинка для текста
  - Glitch-эффекты для киберпанк-элементов

### Страницы

1. **Главная (/)**
   - Навигация по разделам (What-If, Шаблоны, Кино, Приключение, Хоррор)
   - Подсказки с вопросами "что если"
   - Анимированные карточки
   - Переключатель темы

2. **Создание сценария (/what-if)**
   - Форма с полями: название, история, вопрос
   - Валидация полей
   - Кнопка генерации
   - Автозаполнение вопроса из URL

3. **Чат (/chat/[id])**
   - Интерфейс диалога с AI
   - История сообщений
   - Поле ввода новых вопросов
   - Исправлено: повторная генерация при обновлении

4. **Шаблоны (/templates)**
   - Сетка шаблонов (4 колонки на десктопе)
   - Фильтры по категориям
   - Сортировка
   - Детальная страница шаблона

5. **Режим Кино (/cinema)**
   - Выбор жанра
   - Поле ввода завязки
   - Отображение сцен
   - Выбор действий (предустановленные + собственный ввод)
   - Отображение концовки с кодом

6. **Приключение (/adventure)**
   - Текстовый интерфейс квеста
   - Игровой лог с историей действий
   - Поле ввода команд
   - Быстрые кнопки команд
   - Карта мира
   - Инвентарь

7. **Хоррор (/horror)**
   - Темный интерфейс с красными акцентами
   - Игровой лог
   - Поле ввода команд
   - Быстрые кнопки (включить/выключить свет, инвентарь)
   - Статус (время суток, ключи)
   - Достижения

8. **История (/history)**
   - Список сохраненных сценариев
   - Поиск и фильтрация
   - Удаление

9. **Авторизация (/auth)**
   - Форма входа/регистрации
   - Вход через Google

## Технические требования

### Архитектура
- **Frontend**: Next.js 14 (App Router), React 18, TypeScript
- **Стилизация**: Tailwind CSS, shadcn/ui
- **Backend**: Next.js API Routes
- **База данных**: Supabase (PostgreSQL) - опционально
- **AI**: Hugging Face API (Qwen/Qwen2.5-72B-Instruct)
- **Deployment**: Vercel

### API Endpoints

1. **POST /api/generate-scenario**
   - Генерация сценария
   - Параметры: story, question, genre (опционально)
   - Режимы: обычный, cinema, action (для игр)
   - Action-режим: JSON-формат ответа для игровых команд

2. **POST /api/scenario**
   - Сохранение сценария в БД
   - Требует авторизации

3. **GET /api/health-check**
   - Проверка работоспособности AI API

### База данных

**Таблицы Supabase:**

1. **stories**
   - id: uuid
   - user_id: uuid
   - title: string
   - content: text
   - created_at: timestamp

2. **scenarios**
   - id: uuid
   - story_id: uuid
   - user_id: uuid
   - question: text
   - ai_response: text
   - created_at: timestamp

3. **game_saves** (новая)
   - id: uuid
   - user_id: uuid
   - game_type: string (adventure/horror)
   - state: jsonb
   - updated_at: timestamp

### Безопасность
- RLS (Row Level Security) для таблиц Supabase
- Rate limiting для API (10/час гости, 50/час авторизованные)
- Валидация входных данных
- Sanitization от XSS
- CSRF защита (через Next.js)

### Переменные окружения

```env
# Обязательные
HF_TOKEN=your_hugging_face_token

# Опциональные (для сохранения данных)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

## Ограничения и constraints

### AI Генерация
- Таймаут: 60 секунд
- Максимальный размер ответа: 
  - Обычный режим: 1500 токенов
  - Action-режим (игры): 200 токенов
- Temperature: 0.7 (обычный), 0.2-0.3 (action-режим)
- Возможны задержки при высокой нагрузке на Hugging Face

### Хранение
- Гостевой режим: localStorage (~5MB)
- Авторизованные пользователи: Supabase

### Производительность
- Статическая генерация страниц (SSG)
- Инкрементальная регенерация (ISR) не используется
- Кэширование API ответов (5 минут)

## Метрики успеха

- Время генерации сценария < 30 секунд
- Uptime > 99%
- Поддержка последних 2 версий Chrome, Firefox, Safari
- Lighthouse score > 80 (Performance, Accessibility, Best Practices, SEO)

## Дорожная карта

### Реализовано ✅
- [x] Базовая генерация сценариев
- [x] Гостевой режим
- [x] Режим Кино с детерминированными концовками
- [x] 64 шаблона историй
- [x] Интерактивный чат
- [x] Авторизация (Email + Google)
- [x] Сохранение истории
- [x] Адаптивный дизайн
- [x] Темная/светлая тема
- [x] Анимации и эффекты
- [x] **Режим Приключения (текстовый квест)**
- [x] **Хоррор-игра "Пробуждение"**
- [x] **AI-обработка игровых команд в JSON-формате**
- [x] **Облачное сохранение прогресса игр**
- [x] **Исправление дублирования сценариев**
- [x] **Улучшенная темная тема для хоррора**

### В плане
- [ ] Экспорт в PDF
- [ ] Поделиться сценарием
- [ ] Многопользовательский режим (совместное создание)
- [ ] Голосовой ввод
- [ ] Мобильное приложение
- [ ] Оффлайн режим
- [ ] Интеграция с другими AI моделями
- [ ] Больше игровых режимов

## Изменения и версии

### v1.1.0 (Текущая)
- Добавлен режим Приключения (текстовый квест)
- Добавлена хоррор-игра "Пробуждение" с 7 концовками
- AI обработка игровых команд через JSON-формат
- Облачное сохранение прогресса игр
- Исправлено дублирование сценариев при обновлении
- Улучшен контраст текста в темной теме

### v1.0.0
- Релиз с базовым функционалом
- Режим Кино с seed-based генерацией
- 64 шаблона
- Авторизация и сохранение

### v0.9.0
- Добавлен режим Кино
- Улучшен UI/UX
- Добавлены анимации

### v0.8.0
- Интеграция с Hugging Face API
- Гостевой режим
- Базовый чат

---

*Документ последний раз обновлен: Февраль 2026*

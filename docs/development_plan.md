# План разработки "What If"

Этот документ описывает детальный план разработки веб-приложения "What If" на основе технического задания ([`docs/PRD.md`](docs/PRD.md:1)).

## Общая стратегия

Разработка будет вестись поэтапно. В первую очередь будут реализованы все бэкенд-задачи и интеграции (база данных, AI-сервис), чтобы обеспечить стабильную основу. Только после этого начнется работа над пользовательским интерфейсом.

## Mermaid-диаграмма архитектуры

```mermaid
graph TD
    subgraph "Клиент (Next.js)"
        A[/"Главная (/)"] --> B{/"Начать"}
        B --> C[/"Создание сценария (/what-if)"]
        C -- Ввод данных --> D{API Route /api/scenario}
        C -- Сохранение --> E{Supabase}
        F[/"История (/history)"] -- Загрузка данных --> E
        G[/"Авторизация (/auth)"] -- Auth --> E
    end

    subgraph "Бэкенд"
        D -- Запрос --> H[Локальная AI модель]
        H -- Ответ --> D
        D -- Сохранение результата --> E
    end

    subgraph "База данных"
        E[(Supabase DB)]
        E -- "stories" --> F
        E -- "scenarios" --> F
    end

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style F fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#f9f,stroke:#333,stroke-width:2px
    style G fill:#f9f,stroke:#333,stroke-width:2px
```

## Этапы разработки

### Этап 1: Настройка окружения и зависимостей

**Цель:** Подготовить основу проекта и проверить базовые инструменты.

1.  **Проверить зависимости:** Убедиться, что `next`, `react`, `tailwindcss`, `typescript`, `pnpm` установлены и соответствуют версиям.
2.  **Настроить `shadcn/ui`:** Инициализировать `shadcn/ui`, так как его компоненты будут использоваться в дальнейшем.

### Этап 2: Интеграция с Supabase и аутентификация

**Цель:** Реализовать систему пользователей и подготовить базу данных.

1.  **Настроить клиент Supabase:** Создать и настроить клиент в [`src/lib/supabase.ts`](src/lib/supabase.ts:1). Переменные окружения (`SUPABASE_URL`, `SUPABASE_ANON_KEY`) должны быть в `.env.local`.
2.  **Создать таблицы в Supabase:** Выполнить SQL-запросы из `PRD.md` для создания таблиц `stories` и `scenarios`.
3.  **Реализовать логику аутентификации:** Настроить `Auth Provider` в [`src/components/auth-provider.tsx`](src/components/auth-provider.tsx:1) для управления сессией.
4.  **Создать компонент-заглушку для формы:** Создать файл [`src/components/user-auth-form.tsx`](src/components/user-auth-form.tsx:1), который будет содержать базовую логику входа (без UI).

### Этап 3: Реализация бэкенд-логики и интеграция с AI

**Цель:** Запустить ключевую функцию — генерацию сценариев на стороне сервера.

1.  **Создать API-маршрут для AI:**
    *   В файле [`src/app/api/scenario/route.ts`](src/app/api/scenario/route.ts:1) реализовать `POST` обработчик.
    *   Он будет принимать историю и вопрос, обрабатывать их и возвращать результат.
2.  **Реальная интеграция с AI:** В [`src/lib/ai-service.ts`](src/lib/ai-service.ts:1) реализовать интеграцию с выбранной локальной моделью (например, Ollama). Заглушки должны быть заменены реальным кодом.
3.  **Сохранение историй и сценариев:**
    *   После успешной генерации AI-ответа, добавить в API-маршруте [`src/app/api/scenario/route.ts`](src/app/api/scenario/route.ts:1) логику сохранения данных (история, вопрос, ответ) в базу данных Supabase.

### Этап 4: Разработка пользовательского интерфейса

**Цель:** Создать интерфейс для взаимодействия с готовым бэкендом.

1.  **Создать базовую структуру страниц:**
    *   [`src/app/page.tsx`](src/app/page.tsx:1): Главная страница.
    *   [`src/app/what-if/page.tsx`](src/app/what-if/page.tsx:1): Страница создания сценария.
    *   [`src/app/history/page.tsx`](src/app/history/page.tsx:1): Страница истории.
    *   [`src/app/auth/page.tsx`](src/app/auth/page.tsx:1): Страница авторизации.
2.  **Реализовать UI для аутентификации:** Доработать компонент [`src/components/user-auth-form.tsx`](src/components/user-auth-form.tsx:1), добавив поля ввода и кнопки.
3.  **Защитить маршруты:** Создать компонент `protected-route.tsx` для защиты страниц `/what-if` и `/history`.
4.  **Создать UI для генерации сценариев:**
    *   На странице [`src/app/what-if/page.tsx`](src/app/what-if/page.tsx:1) разместить компонент [`src/components/StoryEditor.tsx`](src/components/StoryEditor.tsx:1).
    *   `StoryEditor` будет содержать `textarea` для истории, `input` для вопроса "что если" и кнопку для отправки запроса на API.
    *   Отобразить сгенерированный ответ в компоненте `Card`.
5.  **Отображение истории:**
    *   На странице [`src/app/history/page.tsx`](src/app/history/page.tsx:1) использовать компонент [`src/components/HistoryList.tsx`](src/components/HistoryList.tsx:1).
    *   `HistoryList` будет загружать из Supabase все `scenarios`, связанные с текущим `user_id`, и отображать их.

### Этап 5: Завершение и полировка

**Цель:** Подготовить приложение к использованию.

1.  **Стилизация и адаптивность:** Проверить и доработать внешний вид на всех типах устройств.
2.  **Обработка ошибок и состояний загрузки:** Добавить `skeleton` компоненты для индикации загрузки данных.

Этот план является основой для дальнейшей работы.